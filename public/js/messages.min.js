!function(t){"use strict";new(Backbone.View.extend({el:"#op-page-handle-massages",formClassError:"md-input-danger",events:{"submit #op-form-messages":"handleForm","click .op-massages-rm-js":"removeMessage","click .op-remove-all-mes":"removeAllMessage","click .op-check-message":"checkInbox","click .op-massage-accept":"acceptSheetInbox","click .op-accept-data":"acceptSheetData","click .op-massage-send-back":"sheetOrdererSendBack","click .op-massage-cancel":"cancelOrder","change .op-mes-search, .op-mes-filter-by-user, .op-mes-filter-by-date":"filterMessages"},noticeTpl:_.template('<div class="uk-notify-message <%= classes %>">\t\t\t\t\t\t\t\t        <a class="uk-close"></a>\t\t\t\t\t\t\t\t        <div>\t\t\t\t\t\t\t\t           <%= message %>\t\t\t\t\t\t\t\t        </div>\t\t\t\t\t\t\t\t    </div>'),initialize:function(){var e=t("#mailbox");t("#mailbox_select_all").on("ifChanged",function(){var a=t(this);e.find("[data-md-icheck]").each(function(){t(this).iCheck(a.is(":checked")?"check":"uncheck")})}),t(".op-list-current").ready(function(){var e=t("input[name=op_inbox_auto_open]");if(0<e.length){var a=e.val();t(".op-mes-item-"+a).find(".op-check-message").trigger("click"),history.pushState("","",OPDATA.adminUrl+"massages-manage")}})},formatTextHead:function(e,t){return"<p>"+e+"</p><p>"+t+"</p>"},initInboxSheet:function(e,a){var r=this,s=t(".op-sheet-inbox-show-"+e)[0];this.opSheet=new Handsontable(s,{readOnly:!0,data:a,startRows:100,rowHeaders:!0,colHeaders:!0,colHeaders:[r.formatTextHead("A","User Code"),r.formatTextHead("B","Date"),r.formatTextHead("C","Buyer"),r.formatTextHead("D","Collector"),r.formatTextHead("E","Name items"),r.formatTextHead("F","Code Items"),r.formatTextHead("G","Size"),r.formatTextHead("H","Color"),r.formatTextHead("I","Quantity"),r.formatTextHead("J","Price On Website"),r.formatTextHead("K","Ship Web"),r.formatTextHead("L","Sale"),r.formatTextHead("M","Price Order"),r.formatTextHead("N","Into Money"),r.formatTextHead("O","Day In Stock"),r.formatTextHead("P","Tracking Number"),r.formatTextHead("Q","Weight"),r.formatTextHead("R","Link Items"),r.formatTextHead("S","Status"),r.formatTextHead("T","")],columns:window.ATLLIB.colSheetFormat(),contextMenu:!0,rowHeaders:!0,colWidths:150,manualColumnMove:!0,manualRowMove:!0,manualColumnResize:!0,manualRowResize:!0,minSpareRows:!0,filters:!0,width:t("#page_content_inner").width()-30,height:300,afterInit:function(){var e=this;t("#HandsontableCopyPaste").css("position","absolute"),t("#HandsontableCopyPaste").css("top",0),setTimeout(function(){e.setDataAtCell(a.length,18,"")},500)},cells:function(e,t,a){var r={};return 18==t&&3==OPDATA.user.meta.user_role&&(r.readOnly=!1),r}})},handleForm:function(){var e=this,a={formData:t("#op-form-messages",this.el).serialize()};return altair_helpers.content_preloader_show(),t.ajax({url:OPDATA.adminUrl+"/write-messages",type:"POST",data:a,success:function(a){altair_helpers.content_preloader_hide(),t(".uk-close").trigger("click");var r=e.noticeTpl({message:"Send messages success.",classes:"uk-notify-message-success"});socket.emit("notice-inbox",t("select[name=op_receiver]").val()),t(".op-notify-js",e.el).html(r).show(),setTimeout(function(){t(".op-notify-js",e.el).fadeOut()},2e3)}}),!1},removeMessage:function(e){var a=t(e.currentTarget).attr("data-id"),r=t(e.currentTarget).attr("data-rm"),s=t(".op-mes-item-"+a);t.ajax({url:OPDATA.adminUrl+"/delete-messages",type:"POST",data:{id:a,type:r},success:function(e){s.remove(),UIkit.modal.alert("Delete Success!")}})},removeAllMessage:function(e){var a=new Array,r=t(e.currentTarget).attr("data-rm"),s=t(e.currentTarget).closest("li");t(".op-message-check",this.el).each(function(e,r){r.checked&&a.push(t(r).val())}),t.ajax({url:OPDATA.adminUrl+"/delete-messages",type:"POST",data:{id:a,type:r},success:function(e){t(s).remove(),t.each(a,function(e,a){t(".op-mes-item-"+a).remove()}),UIkit.modal.alert("Delete Success!")}})},filterMessages:function(e){var a=this,r=t(e.currentTarget).val(),s=t(e.currentTarget).attr("data-type"),o=t(e.currentTarget).attr("data-type-mes");0<r.length?(t(".op-list-current",this.el).fadeOut(),t(".op-list-result",this.el).fadeIn(),altair_helpers.content_preloader_show()):(t(".op-list-result",this.el).fadeIn(),t(".op-list-current",this.el).fadeOut(),altair_helpers.content_preloader_hide()),t.ajax({url:OPDATA.adminUrl+"/filter-messages",type:"GET",data:{value:t(e.currentTarget).val(),type:s,typeMes:o},success:function(e){var r=JSON.parse(e);t(".op-list-result",a.el).html(r.data),altair_form_adv.masked_inputs(),altair_helpers.content_preloader_hide()}})},checkInbox:function(e){var a=t(e.currentTarget).attr("data-id"),r=t(".op-data-mes-"+a).val();t(".op-meta-mes-"+a).val();0<r.length&&(r=JSON.parse(r),this.initInboxSheet(a,r)),t.ajax({url:OPDATA.adminUrl+"/update-inbox",type:"POST",data:{id:a},success:function(e){}})},acceptSheetInbox:function(e){var a=t(e.currentTarget).attr("data-id");if(1==t(e.currentTarget).attr("apccet-status"))return t(".uk-close").trigger("click"),UIkit.modal.alert("This data has been added to personal data.!"),!1;t(".op-accept-data").attr("data-id",a)},acceptSheetData:function(e){var a=t(e.currentTarget).attr("data-id");altair_helpers.content_preloader_show(),t.ajax({url:OPDATA.adminUrl+"/accept-sheet",type:"POST",data:{mesId:a,sheetId:t("select[name=op_sheet_accept]").val()},success:function(e){altair_helpers.content_preloader_hide(),t("#modal_message_"+a).find(".op-massage-accept").attr("apccet-status",1),t(".uk-close").trigger("click"),UIkit.modal.alert("Accept Success!")}})},sheetOrdererSendBack:function(e){var a=t(e.currentTarget).attr("data-id");altair_helpers.content_preloader_show(),t.ajax({url:OPDATA.adminUrl+"/sendback-inbox",type:"POST",data:{sheetData:JSON.stringify(this.opSheet.getData()),mesId:a},success:function(e){altair_helpers.content_preloader_hide(),UIkit.modal.alert("Send back success!")}})},cancelOrder:function(){var a=t(e.currentTarget).attr("data-id");altair_helpers.content_preloader_show(),t.ajax({url:OPDATA.adminUrl+"/cancel-order",type:"POST",data:{mesId:a},success:function(e){altair_helpers.content_preloader_hide(),UIkit.modal.alert("Cancel success!")}})}}))}(jQuery);