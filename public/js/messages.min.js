!function(e){"use strict";new(Backbone.View.extend({el:"#op-page-handle-massages",formClassError:"md-input-danger",events:{"submit #op-form-messages":"handleForm","click .op-massages-rm-js":"removeMessage","click .op-remove-all-mes":"removeAllMessage","click .op-check-message":"checkInbox","click .op-massage-accept":"acceptSheetInbox","click .op-accept-data":"acceptSheetData","click .op-massage-send-back":"sheetOrdererSendBack","change .op-mes-search, .op-mes-filter-by-user, .op-mes-filter-by-date":"filterMessages"},noticeTpl:_.template('<div class="uk-notify-message <%= classes %>">\t\t\t\t\t\t\t\t        <a class="uk-close"></a>\t\t\t\t\t\t\t\t        <div>\t\t\t\t\t\t\t\t           <%= message %>\t\t\t\t\t\t\t\t        </div>\t\t\t\t\t\t\t\t    </div>'),initialize:function(){var t=e("#mailbox");e("#mailbox_select_all").on("ifChanged",function(){var a=e(this);t.find("[data-md-icheck]").each(function(){e(this).iCheck(a.is(":checked")?"check":"uncheck")})}),e(".op-list-current").ready(function(){var t=e("input[name=op_inbox_auto_open]");if(0<t.length){var a=t.val();e(".op-mes-item-"+a).find(".op-check-message").trigger("click"),history.pushState("","",OPDATA.adminUrl+"massages-manage")}})},formatTextHead:function(e,t){return"<p>"+e+"</p><p>"+t+"</p>"},initInboxSheet:function(t,a){var s=this,r=e(".op-sheet-inbox-show-"+t)[0];this.opSheet=new Handsontable(r,{readOnly:!0,data:a,startRows:100,rowHeaders:!0,colHeaders:!0,colHeaders:[s.formatTextHead("A","User Code"),s.formatTextHead("B","Date"),s.formatTextHead("C","Buyer"),s.formatTextHead("D","Collector"),s.formatTextHead("E","Name items"),s.formatTextHead("F","Code Items"),s.formatTextHead("G","Size"),s.formatTextHead("H","Color"),s.formatTextHead("I","Quantity"),s.formatTextHead("J","Price On Website"),s.formatTextHead("K","Ship Web"),s.formatTextHead("L","Sale"),s.formatTextHead("M","Price Order"),s.formatTextHead("N","Into Money"),s.formatTextHead("O","Day In Stock"),s.formatTextHead("P","Tracking Number"),s.formatTextHead("Q","Weight"),s.formatTextHead("R","Link Items"),s.formatTextHead("S","Status"),s.formatTextHead("T","")],columns:window.ATLLIB.colSheetFormat(),contextMenu:!0,rowHeaders:!0,colWidths:150,manualColumnMove:!0,manualRowMove:!0,manualColumnResize:!0,manualRowResize:!0,minSpareRows:!0,filters:!0,width:e("#page_content_inner").width()-30,height:300,afterInit:function(){var t=this;e("#HandsontableCopyPaste").css("position","absolute"),e("#HandsontableCopyPaste").css("top",0),setTimeout(function(){t.setDataAtCell(a.length,18,"")},500)},cells:function(e,t,a){var s={};return 18==t&&3==OPDATA.user.meta.user_role&&(s.readOnly=!1),s}})},handleForm:function(){var t=this,a={formData:e("#op-form-messages",this.el).serialize()};return altair_helpers.content_preloader_show(),e.ajax({url:OPDATA.adminUrl+"/write-messages",type:"POST",data:a,success:function(a){altair_helpers.content_preloader_hide(),e(".uk-close").trigger("click");var s=t.noticeTpl({message:"Send messages success.",classes:"uk-notify-message-success"});socket.emit("notice-inbox",e("select[name=op_receiver]").val()),e(".op-notify-js",t.el).html(s).show(),setTimeout(function(){e(".op-notify-js",t.el).fadeOut()},2e3)}}),!1},removeMessage:function(t){var a=e(t.currentTarget).attr("data-id"),s=e(t.currentTarget).attr("data-rm"),r=e(".op-mes-item-"+a);e.ajax({url:OPDATA.adminUrl+"/delete-messages",type:"POST",data:{id:a,type:s},success:function(e){r.remove(),UIkit.modal.alert("Delete Success!")}})},removeAllMessage:function(t){var a=new Array,s=e(t.currentTarget).attr("data-rm"),r=e(t.currentTarget).closest("li");e(".op-message-check",this.el).each(function(t,s){s.checked&&a.push(e(s).val())}),e.ajax({url:OPDATA.adminUrl+"/delete-messages",type:"POST",data:{id:a,type:s},success:function(t){e(r).remove(),e.each(a,function(t,a){e(".op-mes-item-"+a).remove()}),UIkit.modal.alert("Delete Success!")}})},filterMessages:function(t){var a=this,s=e(t.currentTarget).val(),r=e(t.currentTarget).attr("data-type"),o=e(t.currentTarget).attr("data-type-mes");0<s.length?(e(".op-list-current",this.el).fadeOut(),e(".op-list-result",this.el).fadeIn(),altair_helpers.content_preloader_show()):(e(".op-list-result",this.el).fadeIn(),e(".op-list-current",this.el).fadeOut(),altair_helpers.content_preloader_hide()),e.ajax({url:OPDATA.adminUrl+"/filter-messages",type:"GET",data:{value:e(t.currentTarget).val(),type:r,typeMes:o},success:function(t){var s=JSON.parse(t);e(".op-list-result",a.el).html(s.data),altair_form_adv.masked_inputs(),altair_helpers.content_preloader_hide()}})},checkInbox:function(t){var a=e(t.currentTarget).attr("data-id"),s=e(".op-data-mes-"+a).val();e(".op-meta-mes-"+a).val();0<s.length&&(s=JSON.parse(s),this.initInboxSheet(a,s)),e.ajax({url:OPDATA.adminUrl+"/update-inbox",type:"POST",data:{id:a},success:function(e){}})},acceptSheetInbox:function(t){var a=e(t.currentTarget).attr("data-id");if(1==e(t.currentTarget).attr("apccet-status"))return lo,e(".uk-close").trigger("click"),UIkit.modal.alert("This data has been added to personal data.!"),!1;e(".op-accept-data").attr("data-id",a)},acceptSheetData:function(t){var a=e(t.currentTarget).attr("data-id");altair_helpers.content_preloader_show(),e.ajax({url:OPDATA.adminUrl+"/accept-sheet",type:"POST",data:{mesId:a,sheetId:e("select[name=op_sheet_accept]").val()},success:function(t){altair_helpers.content_preloader_hide(),e("#modal_message_"+a).find(".op-massage-accept").attr("apccet-status",1),e(".uk-close").trigger("click"),UIkit.modal.alert("Accept Success!")}})},sheetOrdererSendBack:function(){console.log(this.opSheet.getData())}}))}(jQuery);