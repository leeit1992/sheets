!function(e){"use strict";var t=Backbone.Model.extend({initialize:function(){if(this.get("sheetsNumber")||this.set("sheetsNumber",0),this.get("sheetsWidth")||this.set("sheetsWidth",e("#page_content_inner").width()),!this.get("sheetData")){for(var t=new Array,s=0;s<=10;s++)t.push(["01/06/2017","Hai Trieu","hu shop","CULOTTE PANTS","BJ8187","8","Black","1","22.5","","","22.5","","12/6","","61","http://www.adidas.co.uk/culotte-pants/BJ8187.html"]);this.set("sheetData",t)}this.createView()},colType:function(){return[{type:"date",dateFormat:"DD/MM/YYYY",correctFormat:!0,defaultDate:"01/01/2017"},{},{},{},{},{type:"numeric"},{},{type:"numeric"},{type:"numeric"},{},{},{type:"numeric"},{type:"numeric"},{type:"date",dateFormat:"DD/MM/YYYY",correctFormat:!0,defaultDate:"01/01/2017"},{},{type:"numeric"},{},{editor:"select",selectOptions:["Stock","Out of stock"]},{}]},listCols:function(){return["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S"]},createView:function(){this.view=new s({model:this})},extend:function(){return this}}),s=Backbone.View.extend({el:"#page-canculator",wrapSheets:"#op-content-sheets",noticeTpl:_.template('<div class="uk-notify-message <%= classes %>">                                            <a class="uk-close"></a>                                            <div>                                               <%= message %>                                            </div>                                        </div>'),opSheet:null,events:{"click .op-add-canculator-js":"addCanculator","mouseover .op-toolbar-menu-button":"hoverButtonEditor","click .op-save-sheets-js,.op-save-sheets-new-js":"saveSheets","change #op_filter_sheet":"actionFilter","click .op-icon-bold":"useFilter","click .op-fx--input input":"fxEvent"},initialize:function(){this.listenTo(this.model,"change",this.render),this.listenTo(this.model,"change",this.fixWidthCanculator),this.reizeContentCanculator(),this.render();var t=e("#style_switcher");e("#style_switcher_toggle").click(function(e){e.preventDefault(),t.toggleClass("switcher_active")}),e(document).click(function(){e(".op-set-cell").removeClass("op-current")})},render:function(){var e=this.model.get("sheetsNumber");if(0===e)this.canculatorConfig(0,this.model.get("sheetsWidth"));else for(var t=0;t<e;t++)this.canculatorConfig(e,this.model.get("sheetsWidth"))},canculatorConfig:function(t,s){var a=this,o=e("#op-sheet-"+t)[0];if(this.setColor(),0!==e("#op_sheet_id",this.el).length)var n=e("#op_sheet_data",this.el),n=JSON.parse(n.val());else n=[];this.opSheet=new Handsontable(o,{data:n,startRows:100,rowHeaders:!0,colHeaders:!0,colHeaders:["A - Ngày/Tháng","B - Người Mua","C - Người Order","D - Tên Mặt Hàng","E - Mã Hàng","F - Size","G - Mầu"," H - Số Lượng","I - Giá Web","J - Ship Web","K - Giảm Giá","L - Giá Order","M - Thành Tiền","N - Ngày Hàng Về","O - Tracking Number","P - Cân Nặng","Q - Link Hàng","R - Trạng Thái","S"],columns:a.model.colType(),contextMenu:!0,rowHeaders:!0,colWidths:150,manualColumnMove:!0,manualRowMove:!0,manualColumnResize:!0,manualRowResize:!0,minSpareRows:!0,filters:!0,dropdownMenu:["filter_by_condition","filter_action_bar"],width:s-30,height:window.outerHeight-258,formulas:!0,afterInit:function(){var t=this;e(".wtHolder",this.container).addClass("op-scroll"),this.OpDataSheets={};var s=e("#op_sheet_id",this.el),a=e("#op_sheet_status",this.el);if(0!==s.length){this.sheetId=s.val(),this.sheetStatus=a.val();var o=e("#op_sheet_meta",this.el);this.OpDataSheets=JSON.parse(o.val())}setTimeout(function(){t.setDataAtCell(100,18,"")},500)},afterFilter:function(t){var s=this,o=this.getData().length+4,n=0,i=new Array,r=0,l=new Array,c=0,h=new Array;this.setDataAtCell(o,3,"Total weight"),this.setDataAtCell(o+1,3,"Quantity of items"),this.setDataAtCell(o+2,3,"Total price"),e.each(this.getData(),function(t,o){e.each(o,function(o,u){e(s.getCell(t,o)).css({background:""}),s.setCellMeta(t,o,"background",""),s.setCellMeta(t,o,"color",""),s.OpDataSheets[t+"-"+o]=s.getCellMeta(t,o),15==o&&u==parseInt(u,10)&&(i.push(a.model.listCols()[o]+""+(t+1)),n+=parseInt(u)),7==o&&u==parseInt(u,10)&&(l.push(a.model.listCols()[o]+""+(t+1)),r+=parseInt(u)),11==o&&u==parseFloat(u,10)&&(h.push(a.model.listCols()[o]+""+(t+1)),c+=parseFloat(u))})}),this.setDataAtCell(o,4,"=SUM("+i.join(",")+")"),this.setDataAtCell(o+1,4,"=SUM("+l.join(",")+")"),this.setDataAtCell(o+2,4,"=SUM("+h.join(",")+")"),s.setCellMeta(o,3,"background","#3b9c71"),s.setCellMeta(o,3,"color","#white"),s.OpDataSheets[o+"-3"]=s.getCellMeta(o,3);for(var u=o;u<=o+2;u++)e(s.getCell(u,3)).css({background:"#3b9c71",color:"white"}),e(s.getCell(u,4)).css({background:"#3b9c71",color:"white"}),s.setCellMeta(u,3,"background","#3b9c71"),s.setCellMeta(u,3,"color","white"),s.OpDataSheets[u+"-3"]=s.getCellMeta(u,3),s.setCellMeta(u,4,"background","#3b9c71"),s.setCellMeta(u,4,"color","white"),s.OpDataSheets[u+"-4"]=s.getCellMeta(u,3)},afterRenderer:function(e,t,s,a,o){},afterSelection:function(t,s){var a=this,o=this.getDataAtCell(t,s);e(".handsontableInput").val();e(".op-fx--input input").val(o),e(".op-fx--input input").attr("data-row",t),e(".op-fx--input input").attr("data-col",s),2!=this.sheetStatus&&2==OPDATA.user.meta.user_role&&e(".op-fx--input input").change(function(){a.setDataAtCell(t,s,e(this).val())})},cells:function(e,t,s){var a={};return 2!=this.instance.sheetStatus||2!=OPDATA.user.meta.user_role&&3!=OPDATA.user.meta.user_role||(a.readOnly=!0),17==t&&(a.readOnly=!1),17==t&&2==OPDATA.user.meta.user_role&&(a.readOnly=!0),a.renderer=window.firstRowRenderer,a}}),Handsontable.hooks.add("afterChange",function(t){var s=this;t&&(s.sheetId||e.each(t,function(e,t){}))}),Handsontable.hooks.add("afterSelectionEnd",function(t,s,a,o){for(var n=this,i=new Array,r=s;r<=o;r++)for(var l=t;l<=a;l++)i.push({row:l,col:r});e(".op-bg-cell-color").spectrum({color:"#f00",move:function(t){e.each(i,function(s,a){e(n.getCell(a.row,a.col)).css({background:t.toHexString()}),n.setCellMeta(a.row,a.col,"background",t.toHexString()),n.OpDataSheets[a.row+"-"+a.col]=n.getCellMeta(a.row,a.col)})}}),e(".op-text-cell-color").spectrum({color:"#f00",move:function(t){e.each(i,function(s,a){e(n.getCell(a.row,a.col)).css({color:t.toHexString()}),n.setCellMeta(a.row,a.col,"color",t.toHexString()),n.OpDataSheets[a.row+"-"+a.col]=n.getCellMeta(a.row,a.col)})}})})},fixWidthCanculator:function(){var e=this.model.get("sheetsWidth");this.opSheet.updateSettings({width:e})},setColor:function(){window.firstRowRenderer=function(e,t,s,a,o,n,i){if(Handsontable.renderers.TextRenderer.apply(this,arguments),e.OpDataSheets&&e.OpDataSheets[s+"-"+a]){var r=e.OpDataSheets[s+"-"+a];t.style.color=r.color,t.style.background=r.background}}},addCanculator:function(){var t=parseInt(this.model.get("sheetsNumber"))+1;return e(".op-sheet-tabs-content-js",this.el).append('<li><div class="op-sheet-js" id="op-sheet-'+t+'"/></li>'),e(".op-sheet-tabs-js",this.el).append('<li><a href="#">Sheet '+(t+1)+"</a></li>"),this.model.set("sheetsNumber",t),!1},reizeContentCanculator:function(){var t=this;e(".op-switch-screen-js").click(function(){setTimeout(function(){var s=parseInt(e("#page_content_inner").width());e("body").hasClass("sidebar_main_active")?t.model.set("sheetsWidth",s-40):t.model.set("sheetsWidth",s-26)},500)})},hoverButtonEditor:function(t){e(".op-toolbar-menu-button").each(function(){e(this).removeClass("op-toolbar-menu-button-hover")}),e(t.currentTarget).addClass("op-toolbar-menu-button-hover")},saveSheets:function(t){altair_helpers.content_preloader_show();var s=this,a=(new Array,e(t.currentTarget).attr("data-type"));e.each(this.opSheet.OpDataSheets,function(e,t){t.instance=void 0,t.prop=void 0,t.visualCol=void 0,t.visualRow=void 0,t.renderer=void 0});var o={sheetTitle:e("input[name=op_sheet_title]").val(),sheetDescription:e("textarea[name=op_sheet_description]").val(),sheetData:JSON.stringify(this.opSheet.getData()),sheetMeta:JSON.stringify(this.opSheet.OpDataSheets),saveType:a};return this.opSheet.sheetId&&(o.sheetId=this.opSheet.sheetId),e.post(OPDATA.adminUrl+"save-sheets",o,function(){altair_helpers.content_preloader_hide();var t=s.noticeTpl({message:"Send sheet success.",classes:"uk-notify-message-success"});e(".op-notify-js",s.el).html(t).show(),e("#style_switcher").removeClass("switcher_active"),setTimeout(function(){e(".op-notify-js",s.el).fadeOut()},2e3)}),!1},actionFilter:function(t){e(".op-filter-action").each(function(t,s){e(s).fadeOut(200)});var s=e(t.currentTarget).val();e("#op-filter-"+s).fadeIn(200)},useFilter:function(){console.log(this.opSheet),this.opSheet.updateSettings({columnSummary:[{destinationRow:4,destinationColumn:3,type:"sum",forceNumeric:!0}]})},fxEvent:function(t){var s=e(t.currentTarget).attr("data-col"),a=e(t.currentTarget).attr("data-row");return e(this.opSheet.getCell(a,s)).addClass("op-set-cell op-current"),!1}});new t}(jQuery);