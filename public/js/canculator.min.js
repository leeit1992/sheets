!function(e){"use strict";var t=Backbone.Model.extend({initialize:function(){this.get("sheetsNumber")||this.set("sheetsNumber",0),this.get("sheetsWidth")||this.set("sheetsWidth",e("#page_content_inner").width()),this.get("sheetData")||this.set("sheetData",[]),this.createView()},createView:function(){this.view=new s({model:this})},extend:function(){return this}}),s=Backbone.View.extend({el:"#page-canculator",wrapSheets:"#op-content-sheets",noticeTpl:_.template('<div class="uk-notify-message <%= classes %>">                                            <a class="uk-close"></a>                                            <div>                                               <%= message %>                                            </div>                                        </div>'),opSheet:null,events:{"click .op-add-canculator-js":"addCanculator","mouseover .op-toolbar-menu-button":"hoverButtonEditor","click .op-save-sheets-js":"saveSheets"},initialize:function(){this.listenTo(this.model,"change",this.render),this.listenTo(this.model,"change",this.fixWidthCanculator),this.reizeContentCanculator(),this.render();var t=e("#style_switcher");e("#style_switcher_toggle").click(function(e){e.preventDefault(),t.toggleClass("switcher_active")}),e(".op-fx--input input").bind("paste",function(e){console.log(e.originalEvent.clipboardData.getData("text/html"))})},render:function(){var e=this.model.get("sheetsNumber");if(0===e)this.canculatorConfig(0,this.model.get("sheetsWidth"));else for(var t=0;t<e;t++)this.canculatorConfig(e,this.model.get("sheetsWidth"))},canculatorConfig:function(t,s){var a=e("#op-sheet-"+t)[0];this.setColor(),this.opSheet=new Handsontable(a,{startRows:100,contextMenu:!0,rowHeaders:!0,colHeaders:["Ngày/Tháng","Người Mua","Người Order","Tên Mặt Hàng","Mã Hàng","Size","Mầu"," Số Lượng","Giá Web","Giảm Giá","Giá Order","Sau Thuế","Ship Web","Tổng","Giá VNĐ","Bill Order","Tracking Number","Link Hàng"],colWidths:100,manualColumnMove:!0,manualRowMove:!0,manualColumnResize:!0,manualRowResize:!0,minSpareRows:!0,width:s-30,height:window.outerHeight-258,afterInit:function(t){var s=this;e(".wtHolder",this.container).addClass("op-scroll"),this.OpDataSheets={};var a=e("#op_sheet_id",this.el);if(0!==a.length){this.sheetId=a.val();var o=e("#op_sheet_data",this.el);this.OpDataSheets=JSON.parse(o.val()),e.each(s.OpDataSheets,function(e,t){var a=t.default[3];null==t.default[3]&&(a=" "),s.setDataAtCell(t.default[0],t.default[1],a)})}setTimeout(function(){s.setDataAtCell(100,18,"")},500)},cells:function(e,t,s){var a={};return a.renderer=window.firstRowRenderer,a}}),Handsontable.hooks.add("afterChange",function(t){var s=this;t&&(s.sheetId||e.each(t,function(t,a){var o=s.getCellMeta(a[0],a[1]);e(o.instance.getCell(a[0],a[1])).css({background:o.background,color:o.color}),s.OpDataSheets[a[0]+"-"+a[1]]={default:a,meta:o}}))}),Handsontable.hooks.add("afterSelectionEnd",function(t,s,a,o){for(var n=this,i=new Array,r=s;r<=o;r++)for(var l=t;l<=a;l++)i.push({row:l,col:r}),null==n.getDataAtCell(l,r)&&(n.setDataAtCell(l,r," "),n.OpDataSheets[l+"-"+r]={default:[l,r,null,n.getDataAtCell(l,r)],meta:n.getCellMeta(l,r)});e(".op-bg-cell-color").spectrum({color:"#f00",move:function(t){e.each(i,function(s,a){e(n.getCell(a.row,a.col)).css({background:t.toHexString()}),n.setCellMeta(a.row,a.col,"background",t.toHexString()),null!=n.getDataAtCell(a.row,a.col)&&void 0!==n.OpDataSheets[a.row+"-"+a.col]&&(n.OpDataSheets[a.row+"-"+a.col].meta=n.getCellMeta(a.row,a.col))})}}),e(".op-text-cell-color").spectrum({color:"#f00",move:function(t){e.each(i,function(s,a){e(n.getCell(a.row,a.col)).css({color:t.toHexString()}),n.setCellMeta(a.row,a.col,"color",t.toHexString())})}})})},fixWidthCanculator:function(){var e=this.model.get("sheetsWidth");this.opSheet.updateSettings({width:e})},setColor:function(){window.firstRowRenderer=function(e,t,s,a,o,n,i){if(Handsontable.renderers.TextRenderer.apply(this,arguments),e.OpDataSheets&&e.OpDataSheets[s+"-"+a]){var r=e.OpDataSheets[s+"-"+a];t.style.color=r.meta.color,t.style.background=r.meta.background}}},addCanculator:function(){var t=parseInt(this.model.get("sheetsNumber"))+1;return e(".op-sheet-tabs-content-js",this.el).append('<li><div class="op-sheet-js" id="op-sheet-'+t+'"/></li>'),e(".op-sheet-tabs-js",this.el).append('<li><a href="#">Sheet '+(t+1)+"</a></li>"),this.model.set("sheetsNumber",t),!1},reizeContentCanculator:function(){var t=this;e(".op-switch-screen-js").click(function(){setTimeout(function(){var s=parseInt(e("#page_content_inner").width());e("body").hasClass("sidebar_main_active")?t.model.set("sheetsWidth",s-40):t.model.set("sheetsWidth",s-26)},500)})},hoverButtonEditor:function(t){e(".op-toolbar-menu-button").each(function(){e(this).removeClass("op-toolbar-menu-button-hover")}),e(t.currentTarget).addClass("op-toolbar-menu-button-hover")},saveSheets:function(){altair_helpers.content_preloader_show();var t=this;new Array;e.each(this.opSheet.OpDataSheets,function(e,t){t.meta.instance=void 0,t.meta.prop=void 0,t.meta.visualCol=void 0,t.meta.visualRow=void 0});var s={sheetTitle:e("input[name=op_sheet_title]").val(),sheetMessage:e("textarea[name=op_sheet_message]").val(),sheetData:JSON.stringify(this.opSheet.OpDataSheets)};return e.post(OPDATA.adminUrl+"save-sheets",s,function(){altair_helpers.content_preloader_hide(),t.opSheet.updateSettings({readOnly:!0,cells:function(e,t,s){var a={};return a.readOnly=!0,a.renderer=window.firstRowRenderer,a}});var s=t.noticeTpl({message:"Send sheet success.",classes:"uk-notify-message-success"});e(".op-notify-js",t.el).html(s).show(),e("#style_switcher").removeClass("switcher_active"),setTimeout(function(){e(".op-notify-js",t.el).fadeOut()},2e3)}),!1}});new t}(jQuery);