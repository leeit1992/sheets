!function(e){"use strict";var t=Backbone.Model.extend({initialize:function(){if(this.get("sheetsNumber")||this.set("sheetsNumber",0),this.get("sheetsWidth")||this.set("sheetsWidth",e("#page_content_inner").width()),!this.get("sheetData")){for(var t=new Array,o=0;o<=500;o++)t.push(["01/06/2017","Hai Trieu","hu shop","CULOTTE PANTS","BJ8187","8","Black","1","22.5","","","22.5","","12/6","","61","http://www.adidas.co.uk/culotte-pants/BJ8187.html"]);this.set("sheetData",t)}this.createView()},colType:function(){return[{type:"date",dateFormat:"DD/MM/YYYY",correctFormat:!0,defaultDate:"01/01/2017"},{},{},{},{},{type:"numeric"},{},{type:"numeric"},{type:"numeric"},{},{},{type:"numeric"},{type:"numeric"},{type:"date",dateFormat:"DD/MM/YYYY",correctFormat:!0,defaultDate:"01/01/2017"},{},{type:"numeric"},{},{editor:"select",selectOptions:["Stock","Out of stock"]},{}]},listCols:function(){return["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S"]},createView:function(){this.view=new o({model:this})},extend:function(){return this}}),o=Backbone.View.extend({el:"#page-canculator",wrapSheets:"#op-content-sheets",noticeTpl:_.template('<div class="uk-notify-message <%= classes %>">                                            <a class="uk-close"></a>                                            <div>                                               <%= message %>                                            </div>                                        </div>'),opSheet:null,events:{"click .op-add-canculator-js":"addCanculator","mouseover .op-toolbar-menu-button":"hoverButtonEditor","click .op-save-sheets-js,.op-save-sheets-new-js":"saveSheets","change #op_filter_sheet":"actionFilter","click .op-icon-bold":"useFilter","click .op-fx--input input":"fxEvent"},initialize:function(){this.listenTo(this.model,"change",this.render),this.listenTo(this.model,"change",this.fixWidthCanculator),this.reizeContentCanculator(),this.render();var t=e("#style_switcher");e("#style_switcher_toggle").click(function(e){e.preventDefault(),t.toggleClass("switcher_active")}),e(document).click(function(){e(".op-set-cell").removeClass("op-current")})},render:function(){var e=this.model.get("sheetsNumber");if(0===e)this.canculatorConfig(0,this.model.get("sheetsWidth"));else for(var t=0;t<e;t++)this.canculatorConfig(e,this.model.get("sheetsWidth"))},canculatorConfig:function(t,o){var a=this,s=e("#op-sheet-"+t)[0];if(this.setColor(),0!==e("#op_sheet_id",this.el).length)var n=e("#op_sheet_data",this.el),n=JSON.parse(n.val());else n=[["Ngày/Tháng","Người Mua","Người Order","Tên Mặt Hàng","Mã Hàng","Size","Mầu"," Số Lượng","Giá Web","Ship Web","Giảm Giá","Giá Order","Thành Tiền","Ngày Hàng Về","Tracking Number","Cân Nặng","Link Hàng"]];this.opSheet=new Handsontable(s,{data:n,startRows:100,rowHeaders:!0,colHeaders:!0,colHeaders:["A - Ngày/Tháng","B - Người Mua","C - Người Order","D - Tên Mặt Hàng","E - Mã Hàng","F - Size","G - Mầu"," H - Số Lượng","I - Giá Web","J - Ship Web","K - Giảm Giá","L - Giá Order","M - Thành Tiền","N - Ngày Hàng Về","O - Tracking Number","P - Cân Nặng","Q - Link Hàng","R - Trạng Thái","S"],columns:a.model.colType(),contextMenu:!0,rowHeaders:!0,colWidths:150,manualColumnMove:!0,manualRowMove:!0,manualColumnResize:!0,manualRowResize:!0,minSpareRows:!0,filters:!0,dropdownMenu:["filter_by_condition","filter_action_bar"],width:o-30,height:window.outerHeight-258,formulas:!0,afterInit:function(){var t=this;e(".wtHolder",this.container).addClass("op-scroll"),this.OpDataSheets={};var o=e("#op_sheet_id",this.el);if(0!==o.length){this.sheetId=o.val();var a=e("#op_sheet_meta",this.el);this.OpDataSheets=JSON.parse(a.val())}setTimeout(function(){t.setDataAtCell(100,18,"")},500)},afterFilter:function(t){var o=this,s=this.getData().length+4,n=0,i=new Array,r=0,l=new Array,c=0,h=new Array;this.setDataAtCell(s,3,"Total weight"),this.setDataAtCell(s+1,3,"Quantity of items"),this.setDataAtCell(s+2,3,"Total price"),e.each(this.getData(),function(t,s){e.each(s,function(s,u){e(o.getCell(t,s)).css({background:""}),o.setCellMeta(t,s,"background",""),o.setCellMeta(t,s,"color",""),o.OpDataSheets[t+"-"+s]=o.getCellMeta(t,s),15==s&&u==parseInt(u,10)&&(i.push(a.model.listCols()[s]+""+(t+1)),n+=parseInt(u)),7==s&&u==parseInt(u,10)&&(l.push(a.model.listCols()[s]+""+(t+1)),r+=parseInt(u)),11==s&&u==parseFloat(u,10)&&(h.push(a.model.listCols()[s]+""+(t+1)),c+=parseFloat(u))})}),this.setDataAtCell(s,4,"=SUM("+i.join(",")+")"),this.setDataAtCell(s+1,4,"=SUM("+l.join(",")+")"),this.setDataAtCell(s+2,4,"=SUM("+h.join(",")+")"),o.setCellMeta(s,3,"background","#3b9c71"),o.setCellMeta(s,3,"color","#white"),o.OpDataSheets[s+"-3"]=o.getCellMeta(s,3);for(var u=s;u<=s+2;u++)e(o.getCell(u,3)).css({background:"#3b9c71",color:"white"}),e(o.getCell(u,4)).css({background:"#3b9c71",color:"white"}),o.setCellMeta(u,3,"background","#3b9c71"),o.setCellMeta(u,3,"color","white"),o.OpDataSheets[u+"-3"]=o.getCellMeta(u,3),o.setCellMeta(u,4,"background","#3b9c71"),o.setCellMeta(u,4,"color","white"),o.OpDataSheets[u+"-4"]=o.getCellMeta(u,3)},afterRenderer:function(e,t,o,a,s){},afterSelection:function(t,o){var a=this,s=this.getDataAtCell(t,o);e(".handsontableInput").val();e(".op-fx--input input").val(s),e(".op-fx--input input").attr("data-row",t),e(".op-fx--input input").attr("data-col",o),e(".op-fx--input input").change(function(){a.setDataAtCell(t,o,e(this).val())})},cells:function(e,t,o){var a={};return a.renderer=window.firstRowRenderer,a}}),Handsontable.hooks.add("afterChange",function(t){var o=this;t&&(o.sheetId||e.each(t,function(e,t){}))}),Handsontable.hooks.add("afterSelectionEnd",function(t,o,a,s){for(var n=this,i=new Array,r=o;r<=s;r++)for(var l=t;l<=a;l++)i.push({row:l,col:r});e(".op-bg-cell-color").spectrum({color:"#f00",move:function(t){e.each(i,function(o,a){e(n.getCell(a.row,a.col)).css({background:t.toHexString()}),n.setCellMeta(a.row,a.col,"background",t.toHexString()),n.OpDataSheets[a.row+"-"+a.col]=n.getCellMeta(a.row,a.col)})}}),e(".op-text-cell-color").spectrum({color:"#f00",move:function(t){e.each(i,function(o,a){e(n.getCell(a.row,a.col)).css({color:t.toHexString()}),n.setCellMeta(a.row,a.col,"color",t.toHexString()),n.OpDataSheets[a.row+"-"+a.col]=n.getCellMeta(a.row,a.col)})}})})},fixWidthCanculator:function(){var e=this.model.get("sheetsWidth");this.opSheet.updateSettings({width:e})},setColor:function(){window.firstRowRenderer=function(e,t,o,a,s,n,i){if(Handsontable.renderers.TextRenderer.apply(this,arguments),e.OpDataSheets&&e.OpDataSheets[o+"-"+a]){var r=e.OpDataSheets[o+"-"+a];t.style.color=r.color,t.style.background=r.background}}},addCanculator:function(){var t=parseInt(this.model.get("sheetsNumber"))+1;return e(".op-sheet-tabs-content-js",this.el).append('<li><div class="op-sheet-js" id="op-sheet-'+t+'"/></li>'),e(".op-sheet-tabs-js",this.el).append('<li><a href="#">Sheet '+(t+1)+"</a></li>"),this.model.set("sheetsNumber",t),!1},reizeContentCanculator:function(){var t=this;e(".op-switch-screen-js").click(function(){setTimeout(function(){var o=parseInt(e("#page_content_inner").width());e("body").hasClass("sidebar_main_active")?t.model.set("sheetsWidth",o-40):t.model.set("sheetsWidth",o-26)},500)})},hoverButtonEditor:function(t){e(".op-toolbar-menu-button").each(function(){e(this).removeClass("op-toolbar-menu-button-hover")}),e(t.currentTarget).addClass("op-toolbar-menu-button-hover")},saveSheets:function(t){altair_helpers.content_preloader_show();var o=this,a=(new Array,e(t.currentTarget).attr("data-type"));e.each(this.opSheet.OpDataSheets,function(e,t){t.instance=void 0,t.prop=void 0,t.visualCol=void 0,t.visualRow=void 0,t.renderer=void 0});var s={sheetTitle:e("input[name=op_sheet_title]").val(),sheetDescription:e("textarea[name=op_sheet_description]").val(),sheetData:JSON.stringify(this.opSheet.getData()),sheetMeta:JSON.stringify(this.opSheet.OpDataSheets)};return void 0==a&&(s.sheetId=this.opSheet.sheetId),e.post(OPDATA.adminUrl+"save-sheets",s,function(){altair_helpers.content_preloader_hide();var t=o.noticeTpl({message:"Send sheet success.",classes:"uk-notify-message-success"});e(".op-notify-js",o.el).html(t).show(),e("#style_switcher").removeClass("switcher_active"),setTimeout(function(){e(".op-notify-js",o.el).fadeOut()},2e3)}),!1},actionFilter:function(t){e(".op-filter-action").each(function(t,o){e(o).fadeOut(200)});var o=e(t.currentTarget).val();e("#op-filter-"+o).fadeIn(200)},useFilter:function(){console.log(this.opSheet),this.opSheet.updateSettings({columnSummary:[{destinationRow:4,destinationColumn:3,type:"sum",forceNumeric:!0}]})},fxEvent:function(t){var o=e(t.currentTarget).attr("data-col"),a=e(t.currentTarget).attr("data-row");return e(this.opSheet.getCell(a,o)).addClass("op-set-cell op-current"),!1}});new t}(jQuery);